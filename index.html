<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script>
  // Contrase√±a de acceso
  const ACCESS_PASSWORD = 'incidencias2025'; // ‚Üê C√°mbiala por una segura
  const ACCESS_USER = 'eroski'; // ‚Üê Usuario (opcional, puedes quitarlo)

  // Pide credenciales al cargar
  function requestAccess() {
    const maxAttempts = 3;
    let attempts = 0;

    while (attempts < maxAttempts) {
      const user = prompt('üîê Acceso restringido\nUsuario:', '');
      if (user === null) {
        document.body.innerHTML = '<h1>Acceso denegado</h1><p>No se permiti√≥ el acceso.</p>';
        return false;
      }

      const pass = prompt('üîê Contrase√±a:', '');
      if (pass === null) {
        document.body.innerHTML = '<h1>Acceso denegado</h1><p>No se permiti√≥ el acceso.</p>';
        return false;
      }

      if (user === ACCESS_USER && pass === ACCESS_PASSWORD) {
        return true; // Acceso concedido
      }

      attempts++;
      alert(`Contrase√±a incorrecta. Intento ${attempts}/${maxAttempts}`);
    }

    // Bloquea tras 3 intentos
    document.body.innerHTML = '<h1>üö´ Acceso bloqueado</h1><p>N√∫mero m√°ximo de intentos alcanzado.</p>';
    return false;
  }

  // Ejecuta al cargar
  if (!requestAccess()) {
    throw new Error('Acceso denegado');
  }
</script>
  <title>Gesti√≥n de Incidencias - EROSKI</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet"/>
  <style>
    body { background-color: #f8f9fa; padding-top: 20px; }
    .card { box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .img-thumbnail { cursor: pointer; }
    .closed-badge { background-color: #d32f2f; color: white; }
    .open-badge { background-color: #2e7d32; color: white; }
    .search-section { background-color: #e8f5e8; padding: 15px; border-radius: 8px; }
    .photo-preview { max-width: 100px; margin: 5px; }
  </style>
</head>
<body>

<div class="container">
  <h1 class="text-center mb-4">Gesti√≥n de Incidencias - <strong>SUPERMERCADOS EROSKI</strong></h1>

  <!-- Pesta√±as -->
  <ul class="nav nav-tabs mb-4" id="appTabs">
    <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#nueva">Nueva Incidencia</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#abiertas">Incidencias Abiertas</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#cerradas">Cerradas</a></li>
  </ul>

  <div class="tab-content">

    <!-- 1. NUEVA INCIDENCIA -->
    <div class="tab-pane fade show active" id="nueva">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Registrar Nueva Incidencia</h5>
          <form id="formIncidencia">
            <div class="mb-3">
              <label for="centro" class="form-label">Centro EROSKI</label>
              <select class="form-select" id="centro" required>
                <option value="">Selecciona un centro</option>
                <option>Eroski Binissalem I (6705)</option>
                <option>Eroski Binissalen II (6096)</option>
                <option>Eroski NOVA PARIS-CALVIA (7490)</option>
                <option>Eroski Secar (6495)</option>
                <option>Eroski Son Moix (6801)</option>
                <option>Eroski Dragonera (6350)</option>
                <option>Eroski La Puebla (6362)</option>
                <option>La Puebla 2 (6067)</option>
                <option>Eroski Bendinat (6752)</option>
                <option>Eroski Indioteria (6514)</option>
                <option>Eroski Son Cladera (6538)</option>
                <option>Eroski Mercat de Llevant (6729)</option>
                <option>Eroski Portixol (6753)</option>
                <option>Eroski Can Pastilla (6806)</option>
                <option>Eroski Borne (6831)</option>
                <option>Eroski Santa Mar√≠a I (6309)</option>
                <option>Eroski Santa Mar√≠a II (6694)</option>
                <option>Eroski Escorxador (6363)</option>
                <option>Eroski Coll I (6376)</option>
                <option>Eroski Coll II (6718)</option>
                <option>Eroski Palmanova (6537)</option>
                <option>Eroski Santanvi (6713)</option>
                <option>Eroski Colonia (6499)</option>
                <option>Eroski M√©dico Jose Darder (6749)</option>
                <option>Eroski Consell (6643)</option>
                <option>Eroski Soller II (6692)</option>
                <option>Eroski Capit√°n Salom (6892)</option>
                <option>Eroski Campos II (6653)</option>
                <option>Eroski Llucmajor (6759)</option>
                <option>Eroski Pascual Ribot (6882)</option>
                <option>Eroski Alar√≥ (6719)</option>
                <option>Eroski Lloseta (6308)</option>
                <option>Eroski Capit√°n Salom II (7558)</option>
                <option>Eroski Son Rullan (6439)</option>
                <option>Eroski Son Ferriol (6714)</option>
                <option>Eroski Pascual Ribot II (7557)</option>
                <option>Eroski F√°brica (6983)</option>
                <option>Eroski Archiduque (6625)</option>
                <option>Eroski Navegaci√≥n (7503)</option>
                <option>Eroski Inca (6398)</option>
                <option>Eroski Inca IV NORTE (6066)</option>
                <option>Eroski Andrea Doria (6574)</option>
                <option>Eroski Algaida (6726)</option>
                <option>Eroski Manacor I (6377)</option>
                <option>Eroski Industria (6328)</option>
                <option>Eroski MERCAT NOU (6755)</option>
                <option>Eroski P√©rez Galdos (6756)</option>
                <option>Eroski Pere Garau (6793)</option>
                <option>Eroski Muro (6909)</option>
                <option>Eroski INCA-GRAN V√çA COLOM (6895)</option>
                <option>Eroski Reyes Cat√≥licos (6360)</option>
                <option>Eroski Sa Cabaneta (6852)</option>
              </select>
            </div>

            <div class="mb-3">
              <label for="solicitadoPor" class="form-label">Solicitado por</label>
              <select class="form-select" id="solicitadoPor" required>
                <option value="operario">Operario</option>
                <option value="responsable">Responsable del centro</option>
              </select>
            </div>

            <div class="mb-3">
              <label for="descripcion" class="form-label">Descripci√≥n de la incidencia</label>
              <textarea class="form-control" id="descripcion" rows="3" required></textarea>
            </div>

            <div class="mb-3">
              <label for="materiales" class="form-label">Materiales necesarios</label>
              <input type="text" class="form-control" id="materiales" placeholder="Ej: Destornillador, tornillos M5, etc." />
            </div>

            <div class="mb-3">
              <label for="foto" class="form-label">Adjuntar foto (opcional)</label>
              <input type="file" class="form-control" id="foto" accept="image/*" />
            </div>

            <button type="submit" class="btn btn-primary">Registrar Incidencia</button>
          </form>
        </div>
      </div>
    </div>

    <!-- 2. INCIDENCIAS ABIERTAS -->
    <div class="tab-pane fade" id="abiertas">
      <div class="search-section mb-4">
        <h6>Filtrar Incidencias Abiertas</h6>
        <div class="row g-2">
          <div class="col-md-4">
            <input type="text" class="form-control form-control-sm" id="searchOpen" placeholder="Buscar texto..." />
          </div>
          <div class="col-md-4">
            <select class="form-select form-select-sm" id="filterCentroOpen">
              <option value="">Todos los centros</option>
              <!-- Se llenar√° din√°micamente -->
            </select>
          </div>
          <div class="col-md-4">
            <button class="btn btn-sm btn-outline-secondary w-100" id="btnSearchOpen">Buscar</button>
          </div>
        </div>
      </div>
      <div id="listaAbiertas" class="row"></div>
    </div>

    <!-- 3. INCIDENCIAS CERRADAS -->
    <div class="tab-pane fade" id="cerradas">
      <div class="search-section mb-4">
        <h6>Filtrar Incidencias Cerradas</h6>
        <div class="row g-2">
          <div class="col-md-3">
            <input type="text" class="form-control form-control-sm" id="searchClosed" placeholder="Buscar texto..." />
          </div>
          <div class="col-md-3">
            <select class="form-select form-select-sm" id="filterCentroClosed">
              <option value="">Todos los centros</option>
              <!-- Se llenar√° din√°micamente -->
            </select>
          </div>
          <div class="col-md-3">
            <input type="date" class="form-control form-control-sm" id="fechaDesde" />
          </div>
          <div class="col-md-3">
            <input type="date" class="form-control form-control-sm" id="fechaHasta" />
          </div>
          <div class="col-12 mt-2">
            <button class="btn btn-sm btn-outline-secondary w-100" id="btnSearchClosed">Buscar</button>
          </div>
        </div>
      </div>
      <div id="listaCerradas" class="row"></div>
    </div>

  </div>
</div>

<!-- Modal para ver foto -->
<div class="modal fade" id="photoModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body text-center">
        <img id="modalImage" class="img-fluid" src="" alt="Foto de incidencia"/>
      </div>
    </div>
  </div>
</div>

<!-- Modal para editar incidencia -->
<div class="modal fade" id="editModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Editar Incidencia</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="formEdit">
          <input type="hidden" id="editId"/>
          <div class="mb-3">
            <label>Centro</label>
            <input type="text" class="form-control" id="editCentro" readonly />
          </div>
          <div class="mb-3">
            <label>Solicitado por</label>
            <select class="form-select" id="editSolicitadoPor">
              <option value="operario">Operario</option>
              <option value="responsable">Responsable del centro</option>
            </select>
          </div>
          <div class="mb-3">
            <label>Descripci√≥n</label>
            <textarea class="form-control" id="editDescripcion" rows="3"></textarea>
          </div>
          <div class="mb-3">
            <label>Materiales</label>
            <input type="text" class="form-control" id="editMateriales"/>
          </div>
          <div class="mb-3">
            <label>Foto actual</label>
            <div id="editPhotoPreview"></div>
          </div>
          <div class="mb-3">
            <label>Cambiar foto (opcional)</label>
            <input type="file" class="form-control" id="editFoto" accept="image/*"/>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-success" id="btnCerrarIncidencia">Cerrar Incidencia</button>
        <button type="button" class="btn btn-primary" id="btnGuardarEdicion">Guardar Cambios</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // Datos
  let incidencias = JSON.parse(localStorage.getItem('incidencias')) || [];
  const centros = [
    "Eroski Binissalem I (6705)", "Eroski Binissalen II (6096)", "Eroski NOVA PARIS-CALVIA (7490)",
    "Eroski Secar (6495)", "Eroski Son Moix (6801)", "Eroski Dragonera (6350)", "Eroski La Puebla (6362)",
    "La Puebla 2 (6067)", "Eroski Bendinat (6752)", "Eroski Indioteria (6514)", "Eroski Son Cladera (6538)",
    "Eroski Mercat de Llevant (6729)", "Eroski Portixol (6753)", "Eroski Can Pastilla (6806)",
    "Eroski Borne (6831)", "Eroski Santa Mar√≠a I (6309)", "Eroski Santa Mar√≠a II (6694)",
    "Eroski Escorxador (6363)", "Eroski Coll I (6376)", "Eroski Coll II (6718)", "Eroski Palmanova (6537)",
    "Eroski Santanvi (6713)", "Eroski Colonia (6499)", "Eroski M√©dico Jose Darder (6749)",
    "Eroski Consell (6643)", "Eroski Soller II (6692)", "Eroski Capit√°n Salom (6892)",
    "Eroski Campos II (6653)", "Eroski Llucmajor (6759)", "Eroski Pascual Ribot (6882)",
    "Eroski Alar√≥ (6719)", "Eroski Lloseta (6308)", "Eroski Capit√°n Salom II (7558)",
    "Eroski Son Rullan (6439)", "Eroski Son Ferriol (6714)", "Eroski Pascual Ribot II (7557)",
    "Eroski F√°brica (6983)", "Eroski Archiduque (6625)", "Eroski Navegaci√≥n (7503)",
    "Eroski Inca (6398)", "Eroski Inca IV NORTE (6066)", "Eroski Andrea Doria (6574)",
    "Eroski Algaida (6726)", "Eroski Manacor I (6377)", "Eroski Industria (6328)",
    "Eroski MERCAT NOU (6755)", "Eroski P√©rez Galdos (6756)", "Eroski Pere Garau (6793)",
    "Eroski Muro (6909)", "Eroski INCA-GRAN V√çA COLOM (6895)", "Eroski Reyes Cat√≥licos (6360)",
    "Eroski Sa Cabaneta (6852)"
  ];

  // Generar referencia √∫nica: YYMMDD-XX
  function generarReferencia() {
    const now = new Date();
    const dateStr = now.getFullYear().toString().slice(-2) +
                    String(now.getMonth() + 1).padStart(2, '0') +
                    String(now.getDate()).padStart(2, '0');
    const count = incidencias.filter(i => i.referencia.startsWith(dateStr)).length + 1;
    return `${dateStr}-${String(count).padStart(2, '0')}`;
  }

  // Formatear fecha
  function formatDate(dateStr) {
    const date = new Date(dateStr);
    return date.toLocaleDateString('es-ES');
  }

  // Guardar en localStorage
  function guardarIncidencias() {
    localStorage.setItem('incidencias', JSON.stringify(incidencias));
  }

  // Manejo de fotos
  function obtenerFotoData(fileInput) {
    return new Promise((resolve) => {
      if (!fileInput || !fileInput.files[0]) return resolve(null);
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.readAsDataURL(fileInput.files[0]);
    });
  }

  // Registrar nueva incidencia
  document.getElementById('formIncidencia').addEventListener('submit', async (e) => {
    e.preventDefault();
    const centro = document.getElementById('centro').value;
    const solicitadoPor = document.getElementById('solicitadoPor').value;
    const descripcion = document.getElementById('descripcion').value;
    const materiales = document.getElementById('materiales').value;
    const fotoInput = document.getElementById('foto');

    const foto = await obtenerFotoData(fotoInput);
    const fechaApertura = new Date().toISOString();
    const referencia = generarReferencia();

    const nueva = {
      id: Date.now().toString(),
      referencia,
      centro,
      solicitadoPor,
      descripcion,
      materiales,
      foto,
      fechaApertura,
      fechaCierre: null,
      cerrada: false
    };

    incidencias.push(nueva);
    guardarIncidencias();
    alert(`Incidencia registrada: ${referencia}`);
    document.getElementById('formIncidencia').reset();
  });

  // Cargar centros en filtros
  function cargarCentros() {
    [document.getElementById('filterCentroOpen'), document.getElementById('filterCentroClosed')].forEach(select => {
      select.innerHTML = '<option value="">Todos los centros</option>';
      centros.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c;
        opt.textContent = c;
        select.appendChild(opt);
      });
    });
  }
  cargarCentros();

  // Renderizar lista
  function renderizarLista(selector, filtro) {
    const container = document.querySelector(selector);
    container.innerHTML = '';
    const lista = incidencias.filter(filtro);

    if (lista.length === 0) {
      container.innerHTML = '<p class="text-muted">No hay incidencias que mostrar.</p>';
      return;
    }

    lista.forEach(inc => {
      const fechaApertura = formatDate(inc.fechaApertura);
      const fechaCierre = inc.fechaCierre ? formatDate(inc.fechaCierre) : '‚Äî';
      const badge = inc.cerrada ? '<span class="badge closed-badge">CERRADA</span>' : '<span class="badge open-badge">ABIERTA</span>';

      const div = document.createElement('div');
      div.className = 'col-md-6 col-lg-4 mb-3';
      div.innerHTML = `
        <div class="card h-100">
          <div class="card-body">
            <h6 class="card-subtitle mb-2 text-muted">${inc.referencia}</h6>
            <h5 class="card-title">${inc.centro}</h5>
            <p class="card-text small">${inc.descripcion.substring(0, 100)}${inc.descripcion.length > 100 ? '...' : ''}</p>
            <p><strong>Solicitado por:</strong> ${inc.solicitadoPor === 'operario' ? 'Operario' : 'Responsable'}</p>
            <p><strong>Apertura:</strong> ${fechaApertura}</p>
            <p><strong>Cierre:</strong> ${fechaCierre}</p>
            ${inc.materiales ? `<p><strong>Materiales:</strong> ${inc.materiales}</p>` : ''}
            ${inc.foto ? `<img src="${inc.foto}" class="img-thumbnail photo-preview" data-img="${inc.foto}" alt="Foto"/>` : ''}
            <button class="btn btn-sm btn-info ver-foto-btn" ${inc.foto ? '' : 'disabled'}>Ver Foto</button>
            <button class="btn btn-sm btn-warning edit-btn" data-id="${inc.id}">Editar</button>
            ${!inc.cerrada ? `<button class="btn btn-sm btn-danger close-btn" data-id="${inc.id}">Cerrar</button>` : `<button class="btn btn-sm btn-outline-success reopen-btn" data-id="${inc.id}">Reabrir</button>`}
          </div>
        </div>
      `;
      container.appendChild(div);
    });

    // Eventos de botones
    document.querySelectorAll('.ver-foto-btn:not([disabled])').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const img = e.target.parentElement.querySelector('.photo-preview');
        document.getElementById('modalImage').src = img.dataset.img;
        new bootstrap.Modal(document.getElementById('photoModal')).show();
      });
    });

    document.querySelectorAll('.edit-btn').forEach(btn => {
      btn.addEventListener('click', (e) => abrirModalEdicion(e.target.dataset.id));
    });

    document.querySelectorAll('.close-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        if (confirm('¬øCerrar esta incidencia?')) {
          const id = e.target.dataset.id;
          const inc = incidencias.find(i => i.id === id);
          inc.cerrada = true;
          inc.fechaCierre = new Date().toISOString();
          guardarIncidencias();
          renderizarListas();
        }
      });
    });

    document.querySelectorAll('.reopen-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        if (confirm('¬øReabrir esta incidencia?')) {
          const id = e.target.dataset.id;
          const inc = incidencias.find(i => i.id === id);
          inc.cerrada = false;
          inc.fechaCierre = null;
          guardarIncidencias();
          renderizarListas();
        }
      });
    });
  }

  function renderizarListas() {
    renderizarLista('#listaAbiertas', i => !i.cerrada && filtrarAbiertas(i));
    renderizarLista('#listaCerradas', i => i.cerrada && filtrarCerradas(i));
  }

  // Filtros
  function filtrarAbiertas(inc) {
    const search = document.getElementById('searchOpen').value.toLowerCase();
    const centro = document.getElementById('filterCentroOpen').value;
    if (centro && inc.centro !== centro) return false;
    if (search && !inc.descripcion.toLowerCase().includes(search) && !inc.materiales?.toLowerCase().includes(search)) return false;
    return true;
  }

  function filtrarCerradas(inc) {
    const search = document.getElementById('searchClosed').value.toLowerCase();
    const centro = document.getElementById('filterCentroClosed').value;
    const desde = document.getElementById('fechaDesde').value;
    const hasta = document.getElementById('fechaHasta').value;

    if (centro && inc.centro !== centro) return false;
    if (search && !inc.descripcion.toLowerCase().includes(search) && !inc.materiales?.toLowerCase().includes(search)) return false;
    if (desde) {
      const fecha = new Date(inc.fechaCierre);
      if (fecha < new Date(desde)) return false;
    }
    if (hasta) {
      const fecha = new Date(inc.fechaCierre);
      if (fecha > new Date(hasta)) return false;
    }
    return true;
  }

  document.getElementById('btnSearchOpen').addEventListener('click', () => renderizarListas());
  document.getElementById('btnSearchClosed').addEventListener('click', () => renderizarListas());

  // Editar incidencia
  function abrirModalEdicion(id) {
    const inc = incidencias.find(i => i.id === id);
    if (!inc) return;

    document.getElementById('editId').value = inc.id;
    document.getElementById('editCentro').value = inc.centro;
    document.getElementById('editSolicitadoPor').value = inc.solicitadoPor;
    document.getElementById('editDescripcion').value = inc.descripcion;
    document.getElementById('editMateriales').value = inc.materiales || '';

    const preview = document.getElementById('editPhotoPreview');
    preview.innerHTML = inc.foto ? `<img src="${inc.foto}" class="img-thumbnail" style="max-height: 100px;">` : 'No hay foto';

    const modal = new bootstrap.Modal(document.getElementById('editModal'));
    modal.show();
  }

  document.getElementById('btnGuardarEdicion').addEventListener('click', async () => {
    const id = document.getElementById('editId').value;
    const inc = incidencias.find(i => i.id === id);
    if (!inc) return;

    inc.solicitadoPor = document.getElementById('editSolicitadoPor').value;
    inc.descripcion = document.getElementById('editDescripcion').value;
    inc.materiales = document.getElementById('editMateriales').value;

    const nuevaFoto = await obtenerFotoData(document.getElementById('editFoto'));
    if (nuevaFoto) inc.foto = nuevaFoto;

    guardarIncidencias();
    renderizarListas();
    bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
    alert('Incidencia actualizada');
  });

  document.getElementById('btnCerrarIncidencia').addEventListener('click', () => {
    const id = document.getElementById('editId').value;
    const inc = incidencias.find(i => i.id === id);
    if (!inc || inc.cerrada) return;

    if (confirm('¬øCerrar esta incidencia?')) {
      inc.cerrada = true;
      inc.fechaCierre = new Date().toISOString();
      guardarIncidencias();
      renderizarListas();
      bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
      alert('Incidencia cerrada');
    }
  });

  // Inicializar
  renderizarListas();
</script>

</body>
</html>