<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gesti칩n de Incidencias</title>
<style>
    body {
        font-family: Arial, sans-serif;
        margin: 0;
        background-color: #C7CAD1;
        color: #305991;
    }
    header {
        background-color: #305991;
        color: white;
        padding: 10px;
        text-align: center;
    }
    nav {
        display: flex;
        background-color: #F49D4C;
    }
    nav button {
        flex: 1;
        padding: 15px;
        border: none;
        background-color: #F49D4C;
        color: white;
        font-weight: bold;
        cursor: pointer;
    }
    nav button.active {
        background-color: #305991;
    }
    section {
        display: none;
        padding: 20px;
    }
    section.active {
        display: block;
    }
    form {
        background: white;
        padding: 20px;
        border-radius: 8px;
    }
    input, select, textarea {
        width: 100%;
        padding: 10px;
        margin-top: 10px;
        margin-bottom: 15px;
        border: 1px solid #ccc;
        border-radius: 4px;
    }
    button[type="submit"] {
        background-color: #305991;
        color: white;
        padding: 10px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        background: white;
    }
    table th, table td {
        border: 1px solid #ddd;
        padding: 8px;
    }
    table th {
        background-color: #305991;
        color: white;
    }
</style>

<!-- 游댏 SCRIPT DE LOGIN CON MEMORIA -->
<script>
  const ACCESS_USER = 'lcc';
  const ACCESS_PASSWORD = '123';

  // Verifica si ya est치 autenticado
  function isAuthenticated() {
    return localStorage.getItem('incidencias-auth') === 'true';
  }

  // Marca como autenticado
  function setAuthenticated() {
    localStorage.setItem('incidencias-auth', 'true');
  }

  // Solicita login solo si no est치 autenticado
  function requestAccess() {
    if (isAuthenticated()) return true;

    const maxAttempts = 3;
    let attempts = 0;

    while (attempts < maxAttempts) {
      const user = prompt('游댏 Acceso restringido\nUsuario:', '');
      if (user === null) {
        document.body.innerHTML = '<h1 style="text-align:center; color:#d32f2f; margin-top:50px;">Acceso denegado</h1>';
        return false;
      }
      const pass = prompt('游댏 Contrase침a:', '');
      if (pass === null) {
        document.body.innerHTML = '<h1 style="text-align:center; color:#d32f2f; margin-top:50px;">Acceso denegado</h1>';
        return false;
      }
      if (user === ACCESS_USER && pass === ACCESS_PASSWORD) {
        setAuthenticated();
        return true;
      }
      attempts++;
      alert(`Contrase침a incorrecta. Intento ${attempts}/${maxAttempts}`);
    }

    document.body.innerHTML = '<h1 style="text-align:center; color:#d32f2f; margin-top:50px;">游뛂 Acceso bloqueado</h1>';
    return false;
  }

  // Ejecuta al cargar
  if (!requestAccess()) {
    throw new Error('Acceso denegado');
  }
</script>

</head>
<body>

<header>
    <h1>Gesti칩n de Incidencias EROSKI</h1>
</header>

<nav>
    <button class="tab-btn active" data-tab="crear">Crear</button>
    <button class="tab-btn" data-tab="abiertas">Abiertas</button>
    <button class="tab-btn" data-tab="cerradas">Cerradas</button>
</nav>

<section id="crear" class="active">
    <form id="incidenciaForm">
        <label>Centro:</label>
        <select name="centro" required>
            <option value="">Selecciona un centro</option>
            <option>Eroski Binissalem I (6705)</option>
            <option>Eroski Binissalen II (6096)</option>
            <option>Eroski NOVA PARIS-CALVIA (7490)</option>
            <option>Eroski Secar (6495)</option>
            <option>Eroski Son Moix (6801)</option>
            <option>Eroski Dragonera (6350)</option>
            <option>Eroski La Puebla (6362)</option>
            <option>La Puebla 2 (6067)</option>
            <option>Eroski Bendinat (6752)</option>
            <option>Eroski Indioteria (6514)</option>
            <option>Eroski Son Cladera (6538)</option>
            <option>Eroski Mercat de Llevant (6729)</option>
            <option>Eroski Portixol (6753)</option>
            <option>Eroski Can Pastilla (6806)</option>
            <option>Eroski Borne (6831)</option>
            <option>Eroski Santa Mar칤a I (6309)</option>
            <option>Eroski Santa Mar칤a II (6694)</option>
            <option>Eroski Escorxador (6363)</option>
            <option>Eroski Coll I (6376)</option>
            <option>Eroski Coll II (6718)</option>
            <option>Eroski Palmanova (6537)</option>
            <option>Eroski Santanvi (6713)</option>
            <option>Eroski Colonia (6499)</option>
            <option>Eroski M칠dico Jose Darder (6749)</option>
            <option>Eroski Consell (6643)</option>
            <option>Eroski Soller II (6692)</option>
            <option>Eroski Capit치n Salom (6892)</option>
            <option>Eroski Campos II (6653)</option>
            <option>Eroski Llucmajor (6759)</option>
            <option>Eroski Pascual Ribot (6882)</option>
            <option>Eroski Alar칩 (6719)</option>
            <option>Eroski Lloseta (6308)</option>
            <option>Eroski Capit치n Salom II (7558)</option>
            <option>Eroski Son Rullan (6439)</option>
            <option>Eroski Son Ferriol (6714)</option>
            <option>Eroski Pascual Ribot II (7557)</option>
            <option>Eroski F치brica (6983)</option>
            <option>Eroski Archiduque (6625)</option>
            <option>Eroski Navegaci칩n (7503)</option>
            <option>Eroski Inca (6398)</option>
            <option>Eroski Inca IV NORTE (6066)</option>
            <option>Eroski Andrea Doria (6574)</option>
            <option>Eroski Algaida (6726)</option>
            <option>Eroski Manacor I (6377)</option>
            <option>Eroski Industria (6328)</option>
            <option>Eroski MERCAT NOU (6755)</option>
            <option>Eroski P칠rez Galdos (6756)</option>
            <option>Eroski Pere Garau (6793)</option>
            <option>Eroski Muro (6909)</option>
            <option>Eroski INCA-GRAN V칈A COLOM (6895)</option>
            <option>Eroski Reyes Cat칩licos (6360)</option>
            <option>Eroski Sa Cabaneta (6852)</option>
        </select>

        <label>Solicitado por:</label>
        <select name="solicitadoPor" required>
            <option value="">Selecciona una opci칩n</option>
            <option>Operario</option>
            <option>Encargado tienda</option>
            <option>Jefe de zona</option>
            <option>Directivo dpto. t칠cnico</option>
        </select>

        <label>Descripci칩n:</label>
        <textarea name="descripcion" required></textarea>

        <label>Materiales:</label>
        <input type="text" name="materiales">

        <label>Foto:</label>
        <input type="file" name="foto">

        <button type="submit">Crear Incidencia</button>
    </form>
</section>

<section id="abiertas">
    <h2>Incidencias Abiertas</h2>
    <table id="tablaAbiertas">
        <thead>
            <tr>
                <th>Referencia</th>
                <th>Centro</th>
                <th>Solicitado por</th>
                <th>Descripci칩n</th>
                <th>Materiales</th>
                <th>Foto</th>
                <th>Fecha Apertura</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</section>

<section id="cerradas">
    <h2>Incidencias Cerradas</h2>
    <table id="tablaCerradas">
        <thead>
            <tr>
                <th>Referencia</th>
                <th>Centro</th>
                <th>Solicitado por</th>
                <th>Descripci칩n</th>
                <th>Materiales</th>
                <th>Foto</th>
                <th>Fecha Cierre</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</section>

<script>
const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQPnuyc6xEROYNoCAmSB_aICRJOE4k2ZCOli8awlPn-Agn-fuACB68kKwGpZTjPMo19jW-SmJPIRfzP/pub?gid=0&single=true&output=csv';
const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyof-QWtneajf72yUr7CoSGJBH6Chz_U_kArf7j87UPtINybSxYodZigGmZRkltROjVzw/exec';

document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('section').forEach(sec => sec.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById(btn.dataset.tab).classList.add('active');
    });
});

document.getElementById('incidenciaForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = new FormData(e.target);
    formData.append('referencia', 'REF-' + Date.now());

    try {
        const res = await fetch(APPS_SCRIPT_URL, { method: 'POST', body: formData });
        alert('Incidencia creada correctamente');
        e.target.reset();
        cargarIncidencias();
    } catch (err) {
        alert('Error al crear incidencia');
    }
});

async function cargarIncidencias() {
    try {
        const res = await fetch(SHEET_CSV_URL);
        const data = await res.text();
        const rows = data.split('\n').map(r => r.split(','));
        const headers = rows[0];
        const dataRows = rows.slice(1).filter(r => r.length > 1);

        const abiertas = dataRows.filter(r => r[9] && r[9].trim().toLowerCase() !== 's칤');
        const cerradas = dataRows.filter(r => r[9] && r[9].trim().toLowerCase() === 's칤');

        const tbodyAbiertas = document.querySelector('#tablaAbiertas tbody');
        const tbodyCerradas = document.querySelector('#tablaCerradas tbody');
        tbodyAbiertas.innerHTML = '';
        tbodyCerradas.innerHTML = '';

        abiertas.forEach(r => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${r[1] || '-'}</td><td>${r[2] || '-'}</td><td>${r[3] || '-'}</td><td>${r[4] || '-'}</td><td>${r[5] || '-'}</td><td>${r[6] ? `<a href="${r[6]}" target="_blank">Ver</a>` : '-'}</td><td>${r[7] || '-'}</td>`;
            tbodyAbiertas.appendChild(tr);
        });

        cerradas.forEach(r => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${r[1] || '-'}</td><td>${r[2] || '-'}</td><td>${r[3] || '-'}</td><td>${r[4] || '-'}</td><td>${r[5] || '-'}</td><td>${r[6] ? `<a href="${r[6]}" target="_blank">Ver</a>` : '-'}</td><td>${r[8] || '-'}</td>`;
            tbodyCerradas.appendChild(tr);
        });
    } catch (e) {
        console.error('Error al cargar incidencias:', e);
    }
}

// Cargar al inicio
cargarIncidencias();
</script>

</body>
</html>