<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Gestión de Incidencias Eroski</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f9f9f9; }
    h1 { text-align: center; }
    form { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); margin-bottom: 30px; }
    label { font-weight: bold; display: block; margin-top: 10px; }
    select, input, textarea { width: 100%; padding: 8px; margin-top: 5px; }
    button { margin-top: 15px; padding: 10px; background: #28a745; color: white; border: none; cursor: pointer; }
    button:hover { background: #218838; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: #fff; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #f2f2f2; }
    .container { display: flex; flex-wrap: wrap; gap: 20px; }
    .table-container { flex: 1; min-width: 300px; }
</style>
</head>
<body>

<h1>Gestión de Incidencias Eroski</h1>

<form id="incidenciaForm">
    <label for="centro">Centro:</label>
    <select id="centro" name="centro" required>
        <option value="">Selecciona centro</option>
        <option>Eroski Binissalem I (6705)</option>
        <option>Eroski Binissalen II (6096)</option>
        <option>Eroski NOVA PARIS-CALVIA (7490)</option>
        <option>Eroski Secar (6495)</option>
        <option>Eroski Son Moix (6801)</option>
        <option>Eroski Dragonera (6350)</option>
        <option>Eroski La Puebla (6362)</option>
        <option>La Puebla 2 (6067)</option>
        <option>Eroski Bendinat (6752)</option>
        <option>Eroski Indioteria (6514)</option>
        <option>Eroski Son Cladera (6538)</option>
        <option>Eroski Mercat de Llevant (6729)</option>
        <option>Eroski Portixol (6753)</option>
        <option>Eroski Can Pastilla (6806)</option>
        <option>Eroski Borne (6831)</option>
        <option>Eroski Santa María I (6309)</option>
        <option>Eroski Santa María II (6694)</option>
        <option>Eroski Escorxador (6363)</option>
        <option>Eroski Coll I (6376)</option>
        <option>Eroski Coll II (6718)</option>
        <option>Eroski Palmanova (6537)</option>
        <option>Eroski Santanvi (6713)</option>
        <option>Eroski Colonia (6499)</option>
        <option>Eroski Médico Jose Darder (6749)</option>
        <option>Eroski Consell (6643)</option>
        <option>Eroski Soller II (6692)</option>
        <option>Eroski Capitán Salom (6892)</option>
        <option>Eroski Campos II (6653)</option>
        <option>Eroski Llucmajor (6759)</option>
        <option>Eroski Pascual Ribot (6882)</option>
        <option>Eroski Alaró (6719)</option>
        <option>Eroski Lloseta (6308)</option>
        <option>Eroski Capitán Salom II (7558)</option>
        <option>Eroski Son Rullan (6439)</option>
        <option>Eroski Son Ferriol (6714)</option>
        <option>Eroski Pascual Ribot II (7557)</option>
        <option>Eroski Fábrica (6983)</option>
        <option>Eroski Archiduque (6625)</option>
        <option>Eroski Navegación (7503)</option>
        <option>Eroski Inca (6398)</option>
        <option>Eroski Inca IV NORTE (6066)</option>
        <option>Eroski Andrea Doria (6574)</option>
        <option>Eroski Algaida (6726)</option>
        <option>Eroski Manacor I (6377)</option>
        <option>Eroski Industria (6328)</option>
        <option>Eroski MERCAT NOU (6755)</option>
        <option>Eroski Pérez Galdos (6756)</option>
        <option>Eroski Pere Garau (6793)</option>
        <option>Eroski Muro (6909)</option>
        <option>Eroski INCA-GRAN VÍA COLOM (6895)</option>
        <option>Eroski Reyes Católicos (6360)</option>
        <option>Eroski Sa Cabaneta (6852)</option>
    </select>

    <label for="solicitadoPor">Solicitado por:</label>
    <input type="text" id="solicitadoPor" name="solicitadoPor" required>

    <label for="descripcion">Descripción:</label>
    <textarea id="descripcion" name="descripcion" required></textarea>

    <label for="materiales">Materiales:</label>
    <input type="text" id="materiales" name="materiales">

    <label for="foto">Foto:</label>
    <input type="file" id="foto" name="foto" accept="image/*">

    <button type="submit">Crear incidencia</button>
</form>

<div class="container">
    <div class="table-container">
        <h2>Incidencias Abiertas</h2>
        <table id="tablaAbiertas">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Referencia</th>
                    <th>Centro</th>
                    <th>Solicitado Por</th>
                    <th>Descripción</th>
                    <th>Materiales</th>
                    <th>Foto</th>
                    <th>Fecha Apertura</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div class="table-container">
        <h2>Incidencias Cerradas</h2>
        <table id="tablaCerradas">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Referencia</th>
                    <th>Centro</th>
                    <th>Solicitado Por</th>
                    <th>Descripción</th>
                    <th>Materiales</th>
                    <th>Foto</th>
                    <th>Fecha Apertura</th>
                    <th>Fecha Cierre</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script>
const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQPnuyc6xEROYNoCAmSB_aICRJOE4k2ZCOli8awlPn-Agn-fuACB68kKwGpZTjPMo19jW-SmJPIRfzP/pub?gid=0&single=true&output=csv';
const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyof-QWtneajf72yUr7CoSGJBH6Chz_U_kArf7j87UPtINybSxYodZigGmZRkltROjVzw/exec';

document.getElementById("incidenciaForm").addEventListener("submit", async function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const file = formData.get("foto");

    if (file && file.size > 0) {
        const reader = new FileReader();
        reader.onload = async function() {
            const base64 = reader.result.split(",")[1];
            const payload = {
                centro: formData.get("centro"),
                solicitadoPor: formData.get("solicitadoPor"),
                descripcion: formData.get("descripcion"),
                materiales: formData.get("materiales"),
                foto: base64
            };
            await fetch(APPS_SCRIPT_URL, {
                method: "POST",
                body: JSON.stringify(payload)
            });
            alert("Incidencia creada correctamente");
            location.reload();
        };
        reader.readAsDataURL(file);
    } else {
        const payload = {
            centro: formData.get("centro"),
            solicitadoPor: formData.get("solicitadoPor"),
            descripcion: formData.get("descripcion"),
            materiales: formData.get("materiales"),
            foto: ""
        };
        await fetch(APPS_SCRIPT_URL, {
            method: "POST",
            body: JSON.stringify(payload)
        });
        alert("Incidencia creada correctamente");
        location.reload();
    }
});

async function cargarIncidencias() {
    const res = await fetch(SHEET_CSV_URL);
    const data = await res.text();
    const rows = data.split("\n").map(r => r.split(","));
    const abiertas = [], cerradas = [];

    rows.slice(1).forEach(r => {
        if (r[9] && r[9].trim().toLowerCase() === "sí") cerradas.push(r);
        else abiertas.push(r);
    });

    const tbodyAbiertas = document.querySelector("#tablaAbiertas tbody");
    abiertas.forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${r[0]}</td><td>${r[1]}</td><td>${r[2]}</td><td>${r[3]}</td><td>${r[4]}</td><td>${r[5]}</td><td>${r[6] ? `<a href="${r[6]}" target="_blank">Ver</a>` : ''}</td><td>${r[7]}</td>`;
        tbodyAbiertas.appendChild(tr);
    });

    const tbodyCerradas = document.querySelector("#tablaCerradas tbody");
    cerradas.forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${r[0]}</td><td>${r[1]}</td><td>${r[2]}</td><td>${r[3]}</td><td>${r[4]}</td><td>${r[5]}</td><td>${r[6] ? `<a href="${r[6]}" target="_blank">Ver</a>` : ''}</td><td>${r[7]}</td><td>${r[8]}</td>`;
        tbodyCerradas.appendChild(tr);
    });
}

cargarIncidencias();
</script>

</body>
</html>