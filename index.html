<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Gestión de Incidencias</title>
<style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    form { margin-bottom: 30px; }
    label { display: block; margin-top: 10px; font-weight: bold; }
    input, textarea, select { width: 100%; padding: 8px; margin-top: 5px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background-color: #f0f0f0; }
    img { max-width: 100px; }
</style>
</head>
<body>

<h1>Gestión de Incidencias</h1>

<form id="incidenciaForm">
    <label>Referencia:</label>
    <input type="text" name="referencia" required>

    <label>Centro:</label>
    <input type="text" name="centro" required>

    <label>Solicitado por:</label>
    <input type="text" name="solicitadoPor" required>

    <label>Descripción:</label>
    <textarea name="descripcion" required></textarea>

    <label>Materiales:</label>
    <input type="text" name="materiales">

    <label>Foto:</label>
    <input type="file" id="foto" accept="image/*">

    <label>Cerrada:</label>
    <select name="cerrada">
        <option value="No">No</option>
        <option value="Sí">Sí</option>
    </select>

    <button type="submit">Guardar incidencia</button>
</form>

<h2>Listado de incidencias</h2>
<table id="tablaIncidencias">
    <thead>
        <tr>
            <th>ID</th>
            <th>Referencia</th>
            <th>Centro</th>
            <th>Solicitado por</th>
            <th>Descripción</th>
            <th>Materiales</th>
            <th>Foto</th>
            <th>Fecha Apertura</th>
            <th>Fecha Cierre</th>
            <th>Cerrada</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<script>
const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQPnuyc6xEROYNoCAmSB_aICRJOE4k2ZCOli8awlPn-Agn-fuACB68kKwGpZTjPMo19jW-SmJPIRfzP/pub?gid=0&single=true&output=csv';
const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyof-QWtneajf72yUr7CoSGJBH6Chz_U_kArf7j87UPtINybSxYodZigGmZRkltROjVzw/exec';

document.getElementById('incidenciaForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    const file = document.getElementById('foto').files[0];

    let base64Image = '';
    if (file) {
        base64Image = await toBase64(file);
    }

    const data = {
        id: Date.now(),
        referencia: formData.get('referencia'),
        centro: formData.get('centro'),
        solicitadoPor: formData.get('solicitadoPor'),
        descripcion: formData.get('descripcion'),
        materiales: formData.get('materiales'),
        foto: base64Image,
        fechaApertura: new Date().toLocaleString(),
        fechaCierre: '',
        cerrada: formData.get('cerrada')
    };

    await fetch(APPS_SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify(data)
    });

    e.target.reset();
    cargarIncidencias();
});

function toBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });
}

async function cargarIncidencias() {
    const resp = await fetch(SHEET_CSV_URL + '&_=' + Date.now());
    const text = await resp.text();
    const rows = text.trim().split('\n').map(r => r.split(','));
    const tbody = document.querySelector('#tablaIncidencias tbody');
    tbody.innerHTML = '';
    rows.slice(1).forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = row.map((cell, idx) => {
            if (idx === 6 && cell.startsWith('http')) {
                return `<td><a href="${cell}" target="_blank"><img src="${cell}"></a></td>`;
            }
            return `<td>${cell}</td>`;
        }).join('');
        tbody.appendChild(tr);
    });
}

cargarIncidencias();
setInterval(cargarIncidencias, 60000);
</script>

</body>
</html>
