<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gestión de Incidencias - EROSKI</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    /* Paleta de colores */
    :root {
      --bg-color: #F7F7F7; /* Cultured */
      --primary-color: #004262; /* Ateneo Blue */
      --secondary-color: #4B96B5; /* Cyan Azure */
    }

    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background-color: var(--bg-color);
      color: var(--primary-color);
    }

    header {
      background-color: var(--primary-color);
      color: white;
      padding: 10px;
      text-align: center;
    }

    nav {
      display: flex;
      background-color: var(--secondary-color);
    }

    nav button {
      flex: 1;
      padding: 15px;
      border: none;
      background-color: var(--secondary-color);
      color: white;
      font-weight: bold;
      cursor: pointer;
    }

    nav button.active {
      background-color: var(--primary-color);
    }

    section {
      display: none;
      padding: 20px;
    }

    section.active {
      display: block;
    }

    form {
      background: white;
      padding: 20px;
      border-radius: 8px;
    }

    input, select, textarea {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    button[type="submit"] {
      background-color: var(--primary-color);
      color: white;
      padding: 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
    }

    table th, table td {
      border: 1px solid #ddd;
      padding: 8px;
    }

    table th {
      background-color: var(--primary-color);
      color: white;
    }
  </style>

  <!-- 🔐 LOGIN CON MEMORIA -->
  <script>
    const ACCESS_PASSWORD = '123';
    const ACCESS_USER = 'lcc';

    function isAuthenticated() {
      return localStorage.getItem('auth') === 'true';
    }

    function setAuthenticated() {
      localStorage.setItem('auth', 'true');
    }

    function requestAccess() {
      if (isAuthenticated()) return true;

      const maxAttempts = 3;
      let attempts = 0;
      while (attempts < maxAttempts) {
        const user = prompt('🔐 Acceso restringido\nUsuario:', '');
        if (user === null) {
          document.body.innerHTML = '<h1 class="text-center mt-5">Acceso denegado</h1>';
          return false;
        }
        const pass = prompt('🔐 Contraseña:', '');
        if (pass === null) {
          document.body.innerHTML = '<h1 class="text-center mt-5">Acceso denegado</h1>';
          return false;
        }
        if (user === ACCESS_USER && pass === ACCESS_PASSWORD) {
          setAuthenticated();
          return true;
        }
        attempts++;
        alert(`Contraseña incorrecta. Intento ${attempts}/${maxAttempts}`);
      }
      document.body.innerHTML = '<h1 class="text-center mt-5">🚫 Acceso bloqueado</h1>';
      return false;
    }
    if (!requestAccess()) throw new Error('Acceso denegado');
  </script>
</head>
<body>
  <div class="container">
    <header>
      <h1>Gestión de Incidencias - <strong>SUPERMERCADOS EROSKI</strong></h1>
    </header>

    <nav>
      <button class="tab-btn active" data-tab="crear">Crear Incidencia</button>
      <button class="tab-btn" data-tab="abiertas">Abiertas</button>
      <button class="tab-btn" data-tab="cerradas">Cerradas</button>
    </nav>

    <section id="crear" class="active">
      <form id="incidenciaForm">
        <label>Centro EROSKI:</label>
        <select class="form-select" id="centro" required>
          <option value="">Selecciona centro</option>
          <option>Eroski Binissalem I (6705)</option>
          <option>Eroski NOVA PARIS-CALVIA (7490)</option>
          <option>Eroski Son Moix (6801)</option>
          <option>Eroski La Puebla (6362)</option>
          <option>Eroski Bendinat (6752)</option>
          <option>Eroski Santa María I (6309)</option>
          <option>Eroski Escorxador (6363)</option>
          <option>Eroski Palmanova (6537)</option>
          <option>Eroski Colonia (6499)</option>
          <option>Eroski Capitán Salom (6892)</option>
          <option>Eroski Llucmajor (6759)</option>
          <option>Eroski Alaró (6719)</option>
          <option>Eroski INCA-GRAN VÍA COLOM (6895)</option>
          <option>Eroski Muro (6909)</option>
          <option>Eroski Sa Cabaneta (6852)</option>
        </select>

        <label>Solicitado por:</label>
        <select class="form-select" id="solicitadoPor" required>
          <option value="">Selecciona una opción</option>
          <option>Operario</option>
          <option>Encargado tienda</option>
          <option>Jefe de zona</option>
          <option>Directivo dpto. técnico</option>
        </select>

        <label>Descripción:</label>
        <textarea name="descripcion" rows="3" required></textarea>

        <label>Materiales necesarios:</label>
        <input type="text" name="materiales">

        <label>Foto (opcional):</label>
        <input type="file" name="foto">

        <button type="submit" class="btn btn-primary">Crear Incidencia</button>
      </form>
    </section>

    <section id="abiertas">
      <h2>Incidencias Abiertas</h2>
      <table id="tablaAbiertas">
        <thead>
          <tr>
            <th>Referencia</th>
            <th>Centro</th>
            <th>Solicitado por</th>
            <th>Descripción</th>
            <th>Materiales</th>
            <th>Foto</th>
            <th>Fecha Apertura</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <section id="cerradas">
      <h2>Incidencias Cerradas</h2>
      <table id="tablaCerradas">
        <thead>
          <tr>
            <th>Referencia</th>
            <th>Centro</th>
            <th>Solicitado por</th>
            <th>Descripción</th>
            <th>Materiales</th>
            <th>Foto</th>
            <th>Fecha Cierre</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <script>
      const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQPnuyc6xEROYNoCAmSB_aICRJOE4k2ZCOli8awlPn-Agn-fuACB68kKwGpZTjPMo19jW-SmJPIRfzP/pub?output=csv';
      const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyaKHav8_-jbDH4YnFgg4gOXWCLGUfilpCqBK1JgPjzqWZ6J-m9-z5QfiDWyC46zNMfeg/exec';

      async function cargarDeSheet() {
        try {
          const res = await fetch(SHEET_CSV_URL);
          const csv = await res.text();
          const lines = csv.trim().split('\n');
          if (lines.length < 2) return [];
          const headers = lines[0].split(',').map(h => h.trim());
          return lines.slice(1).map(line => {
            const values = line.split(',').map(v => v.trim());
            const obj = {};
            headers.forEach((h, i) => {
              obj[h] = values[i] || '';
            });
            return obj;
          });
        } catch (e) {
          console.error('Error al cargar CSV', e);
          return [];
        }
      }

      async function guardarEnSheet(inc) {
        try {
          await fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            body: JSON.stringify(inc)
          });
        } catch (e) {}
      }

      function generarRef() {
        const d = new Date();
        const date = d.getFullYear().toString().slice(-2) +
                     String(d.getMonth() + 1).padStart(2, '0') +
                     String(d.getDate()).padStart(2, '0');
        const count = (Array.isArray(incidencias) ? incidencias : [])
          .filter(i => i.referencia && typeof i.referencia === 'string' && i.referencia.startsWith(date))
          .length + 1;
        return `${date}-${String(count).padStart(2, '0')}`;
      }

      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          document.querySelectorAll('section').forEach(sec => sec.classList.remove('active'));
          btn.classList.add('active');
          document.getElementById(btn.dataset.tab).classList.add('active');
        });
      });

      document.getElementById('incidenciaForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const formData = new FormData(e.target);
        formData.append('referencia', 'REF-' + Date.now());

        try {
          const res = await fetch(APPS_SCRIPT_URL, { method: 'POST', body: formData });
          alert('Incidencia creada correctamente');
          e.target.reset();
          cargarIncidencias();
        } catch (err) {
          alert('Error al crear incidencia');
        }
      });

      async function cargarIncidencias() {
        const res = await fetch(SHEET_CSV_URL);
        const data = await res.text();
        const rows = data.split('\n').map(r => r.split(','));
        const abiertas = rows.filter(r => r[9] && r[9].trim().toLowerCase() !== 'sí');
        const cerradas = rows.filter(r => r[9] && r[9].trim().toLowerCase() === 'sí');

        const tbodyAbiertas = document.querySelector('#tablaAbiertas tbody');
        const tbodyCerradas = document.querySelector('#tablaCerradas tbody');
        tbodyAbiertas.innerHTML = '';
        tbodyCerradas.innerHTML = '';

        abiertas.forEach(r => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${r[1]}</td><td>${r[2]}</td><td>${r[3]}</td><td>${r[4]}</td><td>${r[5]}</td><td><a href="${r[6]}" target="_blank">Ver</a></td><td>${r[7]}</td>`;
          tbodyAbiertas.appendChild(tr);
        });

        cerradas.forEach(r => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${r[1]}</td><td>${r[2]}</td><td>${r[3]}</td><td>${r[4]}</td><td>${r[5]}</td><td><a href="${r[6]}" target="_blank">Ver</a></td><td>${r[8]}</td>`;
          tbodyCerradas.appendChild(tr);
        });
      }

      cargarIncidencias();
    </script>
  </div>
</body>
</html>