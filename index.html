<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gestión de Incidencias</title>
<style>
    body {
        font-family: Arial, sans-serif;
        margin: 0;
        background-color: #C7CAD1; /* Azul Perla */
    }
    header {
        background-color: #305991; /* Azul Marino */
        color: white;
        padding: 15px;
        text-align: center;
        font-size: 1.5em;
    }
    .tabs {
        display: flex;
        background-color: #305991;
    }
    .tab {
        flex: 1;
        padding: 10px;
        color: white;
        text-align: center;
        cursor: pointer;
        transition: background 0.3s;
    }
    .tab.active {
        background-color: #F49D4C; /* Naranja */
        color: #305991;
        font-weight: bold;
    }
    .content {
        padding: 20px;
    }
    form {
        background: white;
        padding: 15px;
        border-radius: 10px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    label {
        display: block;
        margin-top: 10px;
        font-weight: bold;
        color: #305991;
    }
    input, select, textarea {
        width: 100%;
        padding: 8px;
        margin-top: 5px;
        border-radius: 5px;
        border: 1px solid #ccc;
        font-size: 1em;
    }
    button {
        background-color: #F49D4C;
        color: white;
        border: none;
        padding: 10px 15px;
        font-size: 1em;
        border-radius: 5px;
        margin-top: 15px;
        cursor: pointer;
    }
    button:hover {
        background-color: #e0862f;
    }
    .card {
        background: white;
        padding: 10px;
        border-radius: 8px;
        margin-bottom: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
</style>
</head>
<body>

<header>Gestión de Incidencias</header>

<div class="tabs">
    <div class="tab active" onclick="showSection('crear')">Crear</div>
    <div class="tab" onclick="showSection('abiertas')">Abiertas</div>
    <div class="tab" onclick="showSection('cerradas')">Cerradas</div>
</div>

<div class="content">
    <!-- Sección Crear -->
    <section id="crear" class="section">
        <form id="incidenciaForm">
            <label for="centro">Centro</label>
            <select id="centro" required>
                <option value="">Selecciona un centro</option>
                <option>Eroski Binissalem I (6705)</option>
                <option>Eroski Binissalen II (6096)</option>
                <option>Eroski NOVA PARIS-CALVIA (7490)</option>
                <option>Eroski Secar (6495)</option>
                <option>Eroski Son Moix (6801)</option>
                <option>Eroski Dragonera (6350)</option>
                <option>Eroski La Puebla (6362)</option>
                <option>La Puebla 2 (6067)</option>
                <option>Eroski Bendinat (6752)</option>
                <option>Eroski Indioteria (6514)</option>
                <option>Eroski Son Cladera (6538)</option>
                <option>Eroski Mercat de Llevant (6729)</option>
                <option>Eroski Portixol (6753)</option>
                <option>Eroski Can Pastilla (6806)</option>
                <option>Eroski Borne (6831)</option>
                <option>Eroski Santa María I (6309)</option>
                <option>Eroski Santa María II (6694)</option>
                <option>Eroski Escorxador (6363)</option>
                <option>Eroski Coll I (6376)</option>
                <option>Eroski Coll II (6718)</option>
                <option>Eroski Palmanova (6537)</option>
                <option>Eroski Santanvi (6713)</option>
                <option>Eroski Colonia (6499)</option>
                <option>Eroski Médico Jose Darder (6749)</option>
                <option>Eroski Consell (6643)</option>
                <option>Eroski Soller II (6692)</option>
                <option>Eroski Capitán Salom (6892)</option>
                <option>Eroski Campos II (6653)</option>
                <option>Eroski Llucmajor (6759)</option>
                <option>Eroski Pascual Ribot (6882)</option>
                <option>Eroski Alaró (6719)</option>
                <option>Eroski Lloseta (6308)</option>
                <option>Eroski Capitán Salom II (7558)</option>
                <option>Eroski Son Rullan (6439)</option>
                <option>Eroski Son Ferriol (6714)</option>
                <option>Eroski Pascual Ribot II (7557)</option>
                <option>Eroski Fábrica (6983)</option>
                <option>Eroski Archiduque (6625)</option>
                <option>Eroski Navegación (7503)</option>
                <option>Eroski Inca (6398)</option>
                <option>Eroski Inca IV NORTE (6066)</option>
                <option>Eroski Andrea Doria (6574)</option>
                <option>Eroski Algaida (6726)</option>
                <option>Eroski Manacor I (6377)</option>
                <option>Eroski Industria (6328)</option>
                <option>Eroski MERCAT NOU (6755)</option>
                <option>Eroski Pérez Galdos (6756)</option>
                <option>Eroski Pere Garau (6793)</option>
                <option>Eroski Muro (6909)</option>
                <option>Eroski INCA-GRAN VÍA COLOM (6895)</option>
                <option>Eroski Reyes Católicos (6360)</option>
                <option>Eroski Sa Cabaneta (6852)</option>
            </select>

            <label for="solicitadoPor">Solicitado por</label>
            <input type="text" id="solicitadoPor" required>

            <label for="descripcion">Descripción</label>
            <textarea id="descripcion" required></textarea>

            <label for="materiales">Materiales</label>
            <input type="text" id="materiales">

            <label for="foto">Foto</label>
            <input type="file" id="foto" accept="image/*">

            <button type="submit">Guardar incidencia</button>
        </form>
    </section>

    <!-- Sección Abiertas -->
    <section id="abiertas" class="section" style="display:none;">
        <div id="listaAbiertas"></div>
    </section>

    <!-- Sección Cerradas -->
    <section id="cerradas" class="section" style="display:none;">
        <div id="listaCerradas"></div>
    </section>
</div>

<script>
const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQPnuyc6xEROYNoCAmSB_aICRJOE4k2ZCOli8awlPn-Agn-fuACB68kKwGpZTjPMo19jW-SmJPIRfzP/pub?gid=0&single=true&output=csv';
const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyof-QWtneajf72yUr7CoSGJBH6Chz_U_kArf7j87UPtINybSxYodZigGmZRkltROjVzw/exec';

function showSection(id) {
    document.querySelectorAll('.section').forEach(sec => sec.style.display = 'none');
    document.getElementById(id).style.display = 'block';
    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
    document.querySelector(`.tab[onclick="showSection('${id}')"]`).classList.add('active');
}

document.getElementById('incidenciaForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const referencia = 'REF-' + Date.now();
    const data = {
        id: Date.now(),
        referencia,
        centro: document.getElementById('centro').value,
        solicitadoPor: document.getElementById('solicitadoPor').value,
        descripcion: document.getElementById('descripcion').value,
        materiales: document.getElementById('materiales').value,
        foto: '',
        fechaApertura: new Date().toLocaleString(),
        fechaCierre: '',
        cerrada: 'No'
    };
    const fotoFile = document.getElementById('foto').files[0];
    const formData = new FormData();
    formData.append('data', JSON.stringify(data));
    if (fotoFile) formData.append('file', fotoFile);

    await fetch(APPS_SCRIPT_URL, { method: 'POST', body: formData });
    alert('Incidencia guardada');
    e.target.reset();
    cargarIncidencias();
});

async function cargarIncidencias() {
    const res = await fetch(SHEET_CSV_URL);
    const text = await res.text();
    const rows = text.split('\n').map(r => r.split(','));
    const abiertas = document.getElementById('listaAbiertas');
    const cerradas = document.getElementById('listaCerradas');
    abiertas.innerHTML = '';
    cerradas.innerHTML = '';
    rows.slice(1).forEach(r => {
        if (r.length < 10) return;
        const card = `<div class="card">
            <strong>${r[2]}</strong><br>
            ${r[4]}<br>
            <em>Solicitado por: ${r[3]}</em>
        </div>`;
        if (r[9].trim().toLowerCase() === 'no') abiertas.innerHTML += card;
        else cerradas.innerHTML += card;
    });
}

cargarIncidencias();
</script>

</body>
</html>
